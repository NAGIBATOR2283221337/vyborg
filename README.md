# Система обработки отчётов

Автоматизированная система для заполнения отчётов на основе сеток вещания с использованием алгоритмов нечёткого сопоставления текста.

## Описание

Система обрабатывает Excel-файлы двух типов:
- **Российские отчёты** - с колонкой "Наименование аудиовизуального произведения"
- **Иностранные отчёты** - с колонкой "Название передачи"

Для каждого типа отчёта система:
1. Анализирует сетку вещания и индексирует программы по датам
2. Сопоставляет названия из отчёта с программами из сетки
3. Заполняет колонку даты/времени информацией о показах
4. Удаляет строки без совпадений (опционально)

## Установка и запуск

### Требования
- Python 3.8+
- Windows (для полной функциональности с Excel COM)

### Быстрый запуск

**Самый простой способ:**
1. Дважды кликните на `start_server.bat`
2. Дождитесь установки зависимостей
3. Откройте браузер на http://localhost:8000

**Демо с проверками:**
```bash
python demo.py
```
Этот скрипт:
- Проверит все зависимости
- Создаст демонстрационные файлы
- Запустит тесты
- Запустит сервер и откроет браузер

### Ручная установка

```bash
# Создание виртуального окружения
python -m venv .venv

# Активация окружения (Windows)
.venv\Scripts\activate

# Установка зависимостей
pip install -r requirements.txt
```

### Запуск сервера

```bash
# Запуск в режиме разработки
uvicorn backend.main:app --reload --port 8000

# Или через Python модуль
python -m uvicorn backend.main:app --reload --port 8000
```

### Тестирование системы

```bash
# Создание примеров файлов для тестирования
python create_examples.py

# Проверка компонентов системы
python test_system.py
```

После запуска:
- API будет доступно по адресу: http://localhost:8000
- Веб-интерфейс: http://localhost:8000
- Документация API: http://localhost:8000/docs
- Healthcheck: http://localhost:8000/health

## Структура проекта

```
project/
├── backend/
│   ├── __init__.py
│   ├── main.py                    # FastAPI приложение
│   └── processors/
│       ├── __init__.py
│       ├── shared.py              # Общие утилиты
│       ├── processor_rus.py       # Обработка российских отчётов
│       └── processor_foreign.py   # Обработка иностранных отчётов
├── frontend/
│   ├── index.html                 # Веб-интерфейс
│   ├── app.js                     # JavaScript логика
│   └── styles.css                 # Стили
├── requirements.txt               # Зависимости Python
├── .gitignore                    # Git ignore файл
└── README.md                     # Этот файл
```

## API Endpoints

### POST /api/process/rus
Обработка российского отчёта

**Параметры:**
- `schedule_file` (file) - файл сетки (.xls/.xlsx)
- `report_file` (file) - файл отчёта (.xls/.xlsx)
- `max_shows` (int, default=3) - максимальное количество показов
- `fuzzy_cutoff` (float, default=0.20) - порог нечёткого поиска
- `min_token_overlap` (float, default=0.35) - минимальное пересечение токенов
- `delete_unmatched` (bool, default=true) - удалять несовпадающие строки

**Пример curl:**
```bash
curl -X POST "http://localhost:8000/api/process/rus" \
  -F "schedule_file=@schedule.xlsx" \
  -F "report_file=@report.xlsx" \
  -F "max_shows=3" \
  -F "fuzzy_cutoff=0.20" \
  -F "min_token_overlap=0.35" \
  -F "delete_unmatched=true" \
  -O -J
```

### POST /api/process/foreign
Обработка иностранного отчёта

Параметры аналогичны `/api/process/rus`

**Пример curl:**
```bash
curl -X POST "http://localhost:8000/api/process/foreign" \
  -F "schedule_file=@schedule.xlsx" \
  -F "report_file=@report.xlsx" \
  -F "max_shows=3" \
  -F "fuzzy_cutoff=0.20" \
  -F "min_token_overlap=0.35" \
  -F "delete_unmatched=true" \
  -O -J
```

## Алгоритм сопоставления

Система использует комбинацию метрик для сопоставления названий:

1. **Нормализация названий**: удаление артикулов, расширений файлов, служебной информации
2. **Токенизация**: разбиение на слова с удалением стоп-слов
3. **Метрики схожести**:
   - Коэффициент Жаккара с нормализацией на минимальное количество токенов
   - Коэффициент схожести последовательностей (SequenceMatcher)
4. **Пороги совпадения**: настраиваемые пороги для разных метрик

## Формат входных файлов

### Сетка вещания
- Строки с датами в формате: "Пятница, 31 октября 2025"
- Колонка A: время (например, "10:30")
- Колонка B: название программы

### Отчёты
Поддерживаются различные форматы заголовков:
- Названия: "Название передачи", "Наименование аудиовизуального произведения"
- Даты: "Дата", "Время", "Дата и время", "Показ"

## Обработка ошибок

Система включает многоступенчатую конверсию файлов:
1. Проверка через openpyxl
2. Excel COM (Windows)
3. LibreOffice 
4. Pandas fallback

## Логирование

Система выводит информацию о:
- Количестве найденных совпадений
- Количестве удалённых строк
- Ошибках обработки

## Примеры файлов

Для тестирования системы запустите:
```bash
python create_examples.py
```

Это создаст папку `examples/` со следующими файлами:
- `sample_schedule.xlsx` - пример сетки вещания
- `sample_report_rus.xlsx` - пример российского отчёта
- `sample_report_foreign.xlsx` - пример иностранного отчёта

## Устранение проблем

### Ошибка "Python не найден"
- Установите Python 3.8+ с официального сайта python.org
- При установке отметьте "Add Python to PATH"

### Ошибка "uvicorn не найден"
```bash
pip install uvicorn[standard]
```

### Ошибка "ModuleNotFoundError"
```bash
# Переустановите зависимости
pip install -r requirements.txt --force-reinstall
```

### Проблемы с Excel файлами
- Система поддерживает .xls и .xlsx файлы
- Автоматическая конверсия через openpyxl, Excel COM, LibreOffice или pandas
- На Windows рекомендуется установить Microsoft Excel для лучшей совместимости

## Разработка

### Структура проекта
```
backend/
├── main.py              # FastAPI приложение
├── processors/
│   ├── shared.py        # Общие утилиты
│   ├── processor_rus.py # Российские отчёты
│   └── processor_foreign.py # Иностранные отчёты
frontend/
├── index.html           # Веб-интерфейс
├── app.js              # JavaScript логика
└── styles.css          # Стили
```

### Логирование
Логи выводятся в консоль при запуске сервера. Включают:
- Количество обработанных строк
- Количество найденных совпадений
- Ошибки обработки файлов

## Лицензия

© 2025 Система обработки отчётов. Все права защищены.
