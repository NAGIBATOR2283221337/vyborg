#!/usr/bin/env python3
"""
–¢–æ—á–Ω—ã–π —Ç–µ—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
–ó–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–∞ —Å—Ç—Ä–æ–∫–µ 12, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–æ—á–Ω–æ –∫–∞–∫ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
"""
import os
import sys
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç–∏
current_dir = Path(__file__).parent
sys.path.insert(0, str(current_dir))
sys.path.insert(0, str(current_dir / "backend"))

def create_exact_user_files():
    """–°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª—ã —Ç–æ—á–Ω–æ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞"""
    from openpyxl import Workbook
    from io import BytesIO

    print("üìÑ –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª—ã —Ç–æ—á–Ω–æ –ø–æ –≤–∞—à–µ–º—É —Å–∫—Ä–∏–Ω—à–æ—Ç—É...")

    # –°–ï–¢–ö–ê (–∫–∞–∫ –≤ –ø–µ—Ä–≤–æ–º —Å–∫—Ä–∏–Ω—à–æ—Ç–µ)
    schedule_wb = Workbook()
    ws = schedule_wb.active

    # –î–∞–Ω–Ω—ã–µ —Å–µ—Ç–∫–∏ –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    ws.cell(1, 1, "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 1 —Å–µ–Ω—Ç—è–±—Ä—è 2025")
    ws.cell(2, 1, "6:00:00")
    ws.cell(2, 2, "–ó–∞—Å—Ç–∞–≤–∫–∞ –°–ú–ò")
    ws.cell(3, 1, "6:00:15")
    ws.cell(3, 2, "–ó–∞—Å—Ç–∞–≤–∫–∞ –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!")
    ws.cell(4, 1, "6:00:25")
    ws.cell(4, 2, "–ì–æ—Ä–∞ —Å–∞–º–æ—Ü–≤–µ—Ç–æ–≤ 61, 62")
    ws.cell(5, 1, "6:26:25")
    ws.cell(5, 2, "–ì–æ—Ä–∞ —Å–∞–º–æ—Ü–≤–µ—Ç–æ–≤ 61, 62")
    ws.cell(6, 1, "6:56:25")
    ws.cell(6, 2, "–ó–∞—Å—Ç–∞–≤–∫–∞ –†–µ–∫–ª–∞–º–∞")
    ws.cell(7, 1, "6:56:35")
    ws.cell(7, 2, "–†–µ–∫–ª–∞–º–∞")
    ws.cell(8, 1, "6:59:45")
    ws.cell(8, 2, "–ó–∞—Å—Ç–∞–≤–∫–∞ –°–ú–ò")
    ws.cell(9, 1, "7:00:00")
    ws.cell(9, 2, "–ü–æ–≤—Ç–æ—Ä")
    ws.cell(10, 1, "7:30:00")
    ws.cell(10, 2, "–ì–æ—Ä–∞ —Å–∞–º–æ—Ü–≤–µ—Ç–æ–≤ 63, 64")

    print("‚úÖ –°–µ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∞")

    # –û–¢–ß–ï–¢ (—Ç–æ—á–Ω–æ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–∫—Ä–∏–Ω—à–æ—Ç—É)
    report_wb = Workbook()
    ws = report_wb.active

    # –ó–∞–ø–æ–ª–Ω—è–µ–º –≤–µ—Ä—Ö–Ω—é—é —á–∞—Å—Ç—å –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ
    ws.cell(2, 4, "–û–¢–ß–ï–¢")
    ws.cell(3, 3, "–æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –∞—É–¥–∏–æ–≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è—Ö")
    ws.cell(4, 3, "–∑–∞ –∏—é–ª—å - —Å–µ–Ω—Ç—è–±—Ä—å (III –∫–≤–∞—Ä—Ç–∞–ª–∞) 2025 –≥. –°–ï–ù–¢–Ø–ë–†–¨")

    ws.cell(6, 1, "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    ws.cell(7, 1, "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –°–ú–ò")
    ws.cell(8, 1, "–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä")
    ws.cell(9, 1, "–û—Ç—á–µ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥")
    ws.cell(9, 3, "—Å 01/09/2025 –≥. –ø–æ 30/09/2025 –≥.")

    # –ó–ê–ì–û–õ–û–í–ö–ò –ù–ê –°–¢–†–û–ö–ï 12 (—Ç–æ—á–Ω–æ –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ)
    ws.cell(12, 1, "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ–≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (–Ω–æ–º–µ—Ä –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–∏–∏)")
    ws.cell(12, 2, "–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –≤—ã—Ö–æ–¥–∞ –≤ —ç—Ñ–∏—Ä (—á–∏—Å–ª–æ, —á–∞—Å—ã, –º–∏–Ω.)")
    ws.cell(12, 3, "–ì–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è")
    ws.cell(12, 4, "–ñ–∞–Ω—Ä (—Ç–∏–ø)")
    ws.cell(12, 5, "–ö–∏–Ω–æ—Å—Ç—É–¥–∏—è (–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å)")
    ws.cell(12, 6, "–°—Ç—Ä–∞–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è")
    ws.cell(12, 7, "–†–µ–∂–∏—Å—Å–µ—Ä")
    ws.cell(12, 8, "–ö–æ–º–ø–æ–∑–∏—Ç–æ—Ä –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –º—É–∑—ã–∫–∏")
    ws.cell(12, 9, "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω. –°–µ–∫)")

    # –î–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞ (—Å—Ç—Ä–æ–∫–∞ 13 –∏ –¥–∞–ª–µ–µ - –Ω–æ –ø–æ–∫–∞ –ø—É—Å—Ç—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    # –î–æ–±–∞–≤–∏–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞—Å—Ç—å —Å —Å–µ—Ç–∫–æ–π
    ws.cell(13, 1, "–ó–∞—Å—Ç–∞–≤–∫–∞ –°–ú–ò")
    ws.cell(13, 2, "01.09.2025")

    ws.cell(14, 1, "–ì–æ—Ä–∞ —Å–∞–º–æ—Ü–≤–µ—Ç–æ–≤")
    ws.cell(14, 2, "01.09.2025")

    ws.cell(15, 1, "–†–µ–∫–ª–∞–º–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞")
    ws.cell(15, 2, "01.09.2025")

    print("‚úÖ –û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –Ω–∞ —Å—Ç—Ä–æ–∫–µ 12")

    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –±–∞–π—Ç—ã
    schedule_buffer = BytesIO()
    schedule_wb.save(schedule_buffer)
    schedule_bytes = schedule_buffer.getvalue()
    schedule_buffer.close()
    schedule_wb.close()

    report_buffer = BytesIO()
    report_wb.save(report_buffer)
    report_bytes = report_buffer.getvalue()
    report_buffer.close()
    report_wb.close()

    return schedule_bytes, report_bytes

def test_exact_structure():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º —Å —Ç–æ—á–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    print("üîç –¢–ï–°–¢ –° –¢–û–ß–ù–û–ô –°–¢–†–£–ö–¢–£–†–û–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø")
    print("=" * 60)

    try:
        from backend.processors import processor_rus

        # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª—ã –ø–æ —Ç–æ—á–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
        schedule_bytes, report_bytes = create_exact_user_files()

        print(f"üìä –†–∞–∑–º–µ—Ä—ã: —Å–µ—Ç–∫–∞={len(schedule_bytes)} –±–∞–π—Ç, –æ—Ç—á–µ—Ç={len(report_bytes)} –±–∞–π—Ç")

        # –û—á–µ–Ω—å –º—è–≥–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
        params = {
            'max_shows': 5,
            'fuzzy_cutoff': 0.05,  # –û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π –ø–æ—Ä–æ–≥
            'min_token_overlap': 0.1,  # –û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π –ø–æ—Ä–æ–≥
            'delete_unmatched': False  # –ù–ï —É–¥–∞–ª—è–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        }

        print(f"‚öôÔ∏è –ú—è–≥–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: {params}")
        print("\n" + "="*60)
        print("üöÄ –ó–ê–ü–£–°–ö –û–ë–†–ê–ë–û–¢–ö–ò –° –û–¢–õ–ê–î–ö–û–ô")
        print("="*60)

        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
        result_bytes = processor_rus.process(schedule_bytes, report_bytes, params)

        print("="*60)
        print(f"üìä –†–ï–ó–£–õ–¨–¢–ê–¢: {len(result_bytes)} –±–∞–π—Ç")

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        result_path = "exact_user_result.xlsx"
        with open(result_path, 'wb') as f:
            f.write(result_bytes)
        print(f"üíæ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {result_path}")

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–¥—Ä–æ–±–Ω–æ
        from openpyxl import load_workbook
        wb = load_workbook(result_path)
        ws = wb.active

        print(f"\nüìã –ü–û–î–†–û–ë–ù–´–ô –ê–ù–ê–õ–ò–ó –†–ï–ó–£–õ–¨–¢–ê–¢–ê:")
        print(f"   –†–∞–∑–º–µ—Ä—ã –ª–∏—Å—Ç–∞: {ws.max_row} —Å—Ç—Ä–æ–∫ x {ws.max_column} –∫–æ–ª–æ–Ω–æ–∫")

        # –ò—â–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
        filled_count = 0
        data_rows = 0

        for r in range(1, ws.max_row + 1):
            row_data = []
            has_data = False

            for c in range(1, min(4, ws.max_column + 1)):
                val = ws.cell(r, c).value
                if val:
                    has_data = True
                    row_data.append(str(val)[:40])
                else:
                    row_data.append("")

            if has_data:
                filled_count += 1
                print(f"   –°—Ç—Ä–æ–∫–∞ {r}: {' | '.join(row_data)}")

                # –°—á–∏—Ç–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ (–Ω–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏)
                if r > 12:  # –ü–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
                    data_rows += 1

        wb.close()

        print(f"\nüìä –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:")
        print(f"   –í—Å–µ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫: {filled_count}")
        print(f"   –°—Ç—Ä–æ–∫ —Å –¥–∞–Ω–Ω—ã–º–∏ (–ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤): {data_rows}")
        print(f"   –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {len(result_bytes)} –±–∞–π—Ç")

        if data_rows > 0:
            print("‚úÖ –§–ê–ô–õ –°–û–î–ï–†–ñ–ò–¢ –î–ê–ù–ù–´–ï!")
            print("–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—É—Å—Ç—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ —Ä–µ—à–µ–Ω–∞!")
            return True
        else:
            print("‚ùå –§–∞–π–ª –≤—Å–µ –µ—â–µ –ø—É—Å—Ç–æ–π")
            print("–î–∞–Ω–Ω—ã–µ –Ω–µ –±—ã–ª–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã")
            return False

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == "__main__":
    print("üéØ –§–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–°–¢ –î–õ–Ø –†–ï–®–ï–ù–ò–Ø –ü–†–û–ë–õ–ï–ú–´ –ü–£–°–¢–´–• –§–ê–ô–õ–û–í")
    print("(–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–æ—á–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤–∞—à–∏—Ö —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤)")
    print("=" * 70)

    success = test_exact_structure()

    print("\n" + "="*70)
    if success:
        print("üéâ –ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê!")
        print("–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–∞—à–∏ —Ñ–∞–π–ª—ã")
        print("–ú–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å–∫–∞—Ç—å: start_server.bat")
    else:
        print("‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê –û–°–¢–ê–ï–¢–°–Ø")
        print("–ù—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞")

    print("="*70)
    input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...")
